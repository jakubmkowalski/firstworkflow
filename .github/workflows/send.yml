name: Trigger and Wait for Artifact

on:
  workflow_dispatch:


jobs:
  prepare-and-trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Prepare environment
        run: |
          # Add commands to prepare your environment here
          echo "Environment prepared"

      - name: Trigger Workflow in Repository 2
        id: trigger_workflow
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/jakubmkowalski/secondworkflow/actions/workflows/workflow_file.yml/dispatches \
            -d '{"ref":"main"}'
      
      - name: Wait for Artifact
        id: wait_for_artifact
        run: |
          artifact_name="desired_artifact_name"
          run_id=""
          artifact_url=""
          for i in {1..30}; do
            response=$(curl -H "Accept: application/vnd.github.v3+json" \
                           -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                           https://api.github.com/repos/jakubmkowalski/secondworkflow/actions/runs)
            run_id=$(echo $response | jq -r '.workflow_runs[] | select(.head_branch == "main") | .id' | head -n 1)
            artifact_url=$(curl -H "Accept: application/vnd.github.v3+json" \
                               -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                               https://api.github.com/repos/jakubmkowalski/secondworkflow/actions/runs/$run_id/artifacts | \
                               jq -r ".artifacts[] | select(.name == \"$artifact_name\") | .archive_download_url")
            if [ -n "$artifact_url" ]; then
              echo "Artifact found: $artifact_url"
              break
            fi
            echo "Artifact not found, waiting..."
            sleep 30
          done
          
          if [ -z "$artifact_url" ]; then
            echo "Artifact not found after waiting."
            exit 1
          fi
          
          echo "::set-output name=artifact_url::$artifact_url"
